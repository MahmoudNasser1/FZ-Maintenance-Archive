# دليل استخدام نظام الإشعارات - نظام أرشيف حالات الصيانة Fix Zone

## نظرة عامة

يقدم نظام أرشيف حالات الصيانة Fix Zone نظامًا متقدمًا للإشعارات في الوقت الحقيقي يمكّن المستخدمين من البقاء على اطلاع بكل التحديثات والتغييرات المتعلقة بحالات الصيانة. يستخدم النظام تقنية WebSockets لتوفير إشعارات فورية دون الحاجة إلى تحديث الصفحة.

## أنواع الإشعارات

### 1. إشعارات تلقائية من النظام

يتم إنشاؤها تلقائيًا استجابة لأحداث النظام، مثل:

- **الحالات المعينة**: عند تعيين حالة صيانة جديدة لفني.
- **تحديثات الحالة**: عند تغيير حالة الصيانة من "قيد العمل" إلى "تم الإنجاز" مثلاً.
- **الملاحظات الجديدة**: عند إضافة ملاحظة جديدة إلى حالة صيانة.
- **المرفقات الجديدة**: عند إضافة مرفق جديد إلى حالة صيانة.
- **تذكيرات المواعيد**: تذكيرات بالمواعيد النهائية الوشيكة.

### 2. الإشعارات الإدارية

يقوم المديرون والمسؤولون بإرسالها للإعلام عن معلومات مهمة:

- **إعلانات**: معلومات عامة للفريق.
- **تحديثات السياسة**: تغييرات في سياسات العمل أو الإجراءات.
- **إشعارات الطوارئ**: معلومات ذات أولوية عالية تتطلب اهتمامًا فوريًا.

## واجهة المستخدم للإشعارات

### قائمة الإشعارات

![قائمة الإشعارات](../docs/images/notification_list.png)

- **زر الإشعارات**: موجود في الشريط العلوي مع عداد للإشعارات غير المقروءة.
- **قائمة منسدلة**: تظهر عند النقر على زر الإشعارات وتعرض آخر الإشعارات.
- **التمييز**: الإشعارات غير المقروءة تظهر بلون مختلف للتمييز.

### صفحة الإشعارات

![صفحة الإشعارات](../docs/images/notification_page.png)

- **قائمة كاملة**: تعرض جميع الإشعارات مع معلومات مفصلة.
- **فلترة**: يمكن تصفية الإشعارات حسب النوع أو الحالة (مقروءة/غير مقروءة).
- **اختصارات**: روابط مباشرة للحالات المرتبطة بالإشعارات.

## إدارة الإشعارات

### تحديد الإشعارات كمقروءة

- **تلقائيًا**: يتم تحديد الإشعار كمقروء تلقائيًا عند النقر عليه والانتقال إلى المحتوى المرتبط.
- **يدويًا**: يمكن تحديد إشعار محدد كمقروء من خلال النقر على أيقونة "تحديد كمقروء".
- **قراءة الكل**: يمكن تحديد جميع الإشعارات كمقروءة دفعة واحدة.

### حذف الإشعارات

- **حذف واحد**: يمكن حذف إشعار محدد من خلال النقر على أيقونة الحذف.
- **حذف المقروءة**: يمكن حذف جميع الإشعارات المقروءة دفعة واحدة.

## إعدادات الإشعارات

يمكن للمستخدمين تخصيص إعدادات الإشعارات الخاصة بهم من صفحة الإعدادات:

![إعدادات الإشعارات](../docs/images/notification_settings.png)

### خيارات الإعدادات

- **الإشعارات في التطبيق**: تمكين/تعطيل الإشعارات داخل التطبيق.
- **الإشعارات عبر البريد الإلكتروني**: تمكين/تعطيل إرسال الإشعارات عبر البريد الإلكتروني.
- **تواتر الملخصات**: اختيار وتيرة استلام ملخصات الإشعارات (يوميًا، أسبوعيًا).
- **أنواع الإشعارات**: اختيار أنواع الإشعارات التي ترغب في استلامها.
- **مستوى الأولوية**: تلقي إشعارات للأحداث ذات أولوية محددة فقط.

## الإشعارات الفورية

### كيفية العمل

يستخدم النظام WebSockets لتوفير إشعارات في الوقت الحقيقي. عندما يحدث حدث يستوجب إشعارًا:

1. يقوم الخادم بإنشاء إشعار في قاعدة البيانات.
2. يتم إرسال الإشعار فورًا عبر WebSocket إلى المستخدمين المعنيين.
3. يعرض التطبيق الإشعار دون الحاجة إلى تحديث الصفحة.

### مؤشرات النشاط

يتضمن النظام مؤشرات حالة الاتصال:

- **متصل**: النظام متصل ويستقبل الإشعارات الفورية.
- **قيد إعادة الاتصال**: النظام يحاول إعادة الاتصال بعد انقطاع.
- **غير متصل**: النظام غير متصل ولا يمكنه استقبال إشعارات فورية.

## استخدام API الإشعارات للمطورين

### استرجاع الإشعارات

```http
GET /api/v1/notifications
```

**المعلمات**:
- `is_read` (اختياري): تصفية حسب حالة القراءة (true/false)
- `skip` (اختياري): عدد العناصر للتخطي
- `limit` (اختياري): الحد الأقصى للنتائج

**الاستجابة**:
```json
[
  {
    "id": "123e4567-e89b-12d3-a456-426614174000",
    "recipient_id": "123e4567-e89b-12d3-a456-426614174001",
    "message": "تم تعيين حالة صيانة جديدة: #12345",
    "is_read": false,
    "related_case_id": "123e4567-e89b-12d3-a456-426614174002",
    "created_at": "2023-04-01T10:30:00Z"
  },
  // المزيد من الإشعارات...
]
```

### عدد الإشعارات غير المقروءة

```http
GET /api/v1/notifications/count
```

**الاستجابة**:
```json
5
```

### تحديد إشعار كمقروء

```http
PUT /api/v1/notifications/{notification_id}/read
```

**الاستجابة**:
```json
{
  "id": "123e4567-e89b-12d3-a456-426614174000",
  "recipient_id": "123e4567-e89b-12d3-a456-426614174001",
  "message": "تم تعيين حالة صيانة جديدة: #12345",
  "is_read": true,
  "related_case_id": "123e4567-e89b-12d3-a456-426614174002",
  "created_at": "2023-04-01T10:30:00Z"
}
```

### تحديد جميع الإشعارات كمقروءة

```http
PUT /api/v1/notifications/read-all
```

**الاستجابة**:
```json
{
  "success": true,
  "message": "تم تحديث 5 إشعارات كمقروءة",
  "count": 5
}
```

### الاتصال بـ WebSocket

```javascript
// مثال JavaScript على جانب العميل
const token = "your_jwt_token"; // رمز JWT للمستخدم
const socket = new WebSocket(`ws://example.com/api/v1/notifications/ws/${token}`);

socket.onopen = () => {
  console.log("تم الاتصال بنظام الإشعارات");
};

socket.onmessage = (event) => {
  const notification = JSON.parse(event.data);
  // معالجة الإشعار الجديد
  console.log("إشعار جديد:", notification);
  // عرض الإشعار في واجهة المستخدم
  displayNotification(notification);
};

socket.onclose = () => {
  console.log("تم إغلاق الاتصال");
  // إعادة الاتصال بعد فترة
  setTimeout(reconnectWebSocket, 5000);
};
```

## استكشاف الأخطاء وإصلاحها

### المشكلات الشائعة وحلولها

#### لا تظهر الإشعارات الفورية
- **السبب المحتمل**: قد يكون اتصال WebSocket منقطعًا.
- **الحل**: تحقق من حالة الاتصال في واجهة المستخدم. انقر على زر "إعادة الاتصال" أو قم بتحديث الصفحة.

#### عدم تحديث عداد الإشعارات
- **السبب المحتمل**: يمكن أن تكون هناك مشكلة في مزامنة القراءة.
- **الحل**: انقر على "تحديث" أو اذهب إلى صفحة الإشعارات ثم عد.

#### الإشعارات القديمة لا تختفي
- **السبب المحتمل**: قد تحتاج إلى تنظيف الإشعارات القديمة يدويًا.
- **الحل**: انقر على "حذف المقروءة" في صفحة الإشعارات.

## خاتمة

نظام الإشعارات في الوقت الحقيقي هو جزء أساسي من نظام أرشيف حالات الصيانة Fix Zone، ويساعد في تحسين التواصل وزيادة الإنتاجية من خلال إبقاء جميع أعضاء الفريق على اطلاع دائم بآخر المستجدات.

يُرجى مراجعة هذا الدليل بانتظام حيث يتم تحديث الميزات والوظائف باستمرار لتحسين تجربة المستخدم.
